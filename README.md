# vtrgo-nfc-scanner

Firmware for the **STM32-based NFC scanning module** that integrates with [vtrgo-data-dashboard/console](https://github.com/vtrgo/vtrgo-data-dashboard/tree/main/console).  
This project enables **real-time NFC data capture** and communication with the dashboard backend, supporting industrial monitoring and control applications.  

It provides low-latency NFC scanning, HTTP reporting, and hardware fault handling for deployment in factory environments.  

---

## ✨ Features

- **NFC Scanning**
  - Runs on **NUCLEO-H755ZI-Q** with the **X-NUCLEO-NFC07A1** expansion board (ST25DV04K dynamic tag).  
  - Supports both **dynamic NFC tags** and **standard NDEF** formats.  


- **Network Communication**
  - Periodically sends results to the backend via HTTP `GET`/`POST`.  
  - Configurable backend endpoint (default: `http://192.168.1.133:8080/api/...`).  

- **Fault Handling & Recovery**
  - Detects idle/network failures and retries automatically.  
  - On boot, performs health checks before scanning resumes.  

- **Lightweight Logging**
  - Outputs debug/status messages via UART (baud rate: 115200).  

- **Low Power Operation**
  - Optimized idle mode behavior to reduce unnecessary power draw.  

---

## 🛠️ Tech Stack

- **MCU Board**: NUCLEO-H755ZI-Q (STM32H755 dual-core)  
- **NFC Expansion**: X-NUCLEO-NFC07A1 (ST25DV04K dynamic tag)  
- **Language**: C (STM32 HAL/LL drivers)  
- **Build System**: STM32CubeIDE  
- **Networking**: LwIP + HTTP client  
 

---

## 📂 Project Structure

```
vtrgo-nfc-scanner/
├── Core/            # Source code
│   ├── Inc/     # Header files
│   ├── Src/ # Source files
│   │   ├── main.c     # Main logic
├── Drivers/      # STM32 HAL/LL peripheral drivers (auto-generated by CubeMX)
├── mongoose/    # mongoose logic/config files
```


---

## ⚙️ How It Works

1. **Initialization**  
   On startup, the MCU initializes clocks, GPIOs, NFC hardware, and the network stack.  

2. **Button Trigger → Request & Write**  
   - When the **button (PC13)** is pressed, the MCU:  
     1. Sends an HTTP request to the backend.  
     2. Waits for the response.  
     3. Writes the JSON data to the NFC tag.  
   - The **LED on PB14** indicates activity during this process.  

3. **NFC Scan Trigger → Read & Update**  
   - When an NFC **scan is detected (PA6 low)**, the MCU:  
     1. Reads the contents of the NFC tag.  
     2. Checks if the message originated from the phone.  
     3. If valid, makes a second HTTP request to the backend for specific data.  
     4. Writes the updated information back to the NFC tag.  
   - The **LED on PB0** indicates scanning activity.  

4. **Backend Communication**  
   - Results are exchanged with the dashboard backend ([vtrgo-data-dashboard](https://github.com/vtrgo/vtrgo-data-dashboard/tree/main/console)) over HTTP.  
   - Endpoints used:  
     - `/api/stats` → system status updates  
     - `/api/float-range` → float/analog data (if supported)  

5. **Error Handling**  
   - If a network request fails (e.g., first request after a long idle), the firmware retries until successful.  

6. **Idle Behavior**  
   - When no button is pressed and no NFC scan occurs, the MCU remains in the main polling loop with minimal activity.  


## 📋 Prerequisites

- STM32 development environment STM32CubeIDE. 
- `stlink` or compatible debugger/programmer.  
- Access to a running instance of the **vtrgo-data-dashboard service**.  

---

# 📡 VTRGO NFC Scanner

Firmware project for the **NUCLEO-H755ZI-Q** with the **X-NUCLEO-NFC07A1** expansion shield.  
Provides NFC scan, HTTP request, and NFC write-back functionality.

---

# 🚀 Build & Flash

### 1. Clone the repository
git clone https://github.com/vtrgo/vtrgo-nfc-scanner.git
cd vtrgo-nfc-scanner

### 2. Open in STM32CubeIDE
Launch STM32CubeIDE

Go to File → Open Projects from File System...

Select the vtrgo-nfc-scanner/ directory

CubeIDE will auto-detect the project configuration

### 3. Configure Build
Target MCU: NUCLEO-H755ZI-Q

Attach X-NUCLEO-NFC07A1 shield to the Nucleo expansion header

Enable middleware if required (e.g., LwIP, FreeRTOS)

### 4. Build the Firmware
Menu: Project → Build Project

Or use keyboard shortcuts:

Ctrl+B (Windows/Linux)

⌘B (Mac)

### 5. Flash to Device
Connect the Nucleo board via USB (ST-LINK)

Click Run → Debug or Run → Run in CubeIDE

CubeIDE will compile and flash automatically

### 6. Verify
Press User Button (PC13) → triggers HTTP request + NFC write

Scan with an NFC-enabled phone/tag → reads NFC, validates, fetches from backend, and rewrites

🔦 LED Indicators
PB0 → NFC scan activity

PB14 → Button-triggered HTTP + NFC write

